# Лаба 3 со звездочкой

В качестве секретохранилки использовалась Hashicorp Vault, но на Ubuntu поработать с ней не удалось ввиду того, что в России Hashicorp запрещен. Упорными действиями получилось добыть доступ к нему только на Windows.

Хранение секретов в CI/CD переменных репозитория не является хорошей практикой, потому что это может привести к утечке конфиденциальных данных. Злоумышленник может получить доступ к секретам и воспользоваться ими в своих целях.

## Настройка Vault.

Первым делом был установлен Hashicorp Vault по ссылке: `https://developer.hashicorp.com/vault/install`.

После установки перейдем в консоль и настроим Hashicorp. Изначально нужно перейти в директорию, где находятся все установленные нами файлы. При помощи `vault server -dev` переходим в режим локальной разработки. Нам в консоли выйдет сообщение, что режим разработки запущен. На скрине представлено то, что вывелось в консоли.

![2024-10-11_16-38-17](https://github.com/user-attachments/assets/4ab664dd-a580-4a3c-9dda-62739d802605)

В строчке, где написано VAULT_ADDR, указан адрес, который следует указать в самом пайплайне для подключения к серверу, где будем хранить секреты.

На скрине виден также токен Root Token, который нужно занести в Github Secrets. Он нужен для аутентификации.

Далее открываем второе окно терминала и прописываем команды:

`set VAULT_ADDR=http://127.0.0.1:8200`

`set VAULT_TOKEN=<наш_токен>`

Таким образом мы задаем переменные среды. Это нужно для того, чтоб не было проблем с аутентификацией и упрощения работы. Действия представлены на скрине ниже.

![2024-10-11_18-44-34](https://github.com/user-attachments/assets/48b4c52e-c8fe-4796-a848-fab5227813a6)

Теперь запишем необходимые нам секреты в Hashicorp Vault при помощи команды `vault kv put`. Нам нужно указать путь сохранения наших секретов, в данном случае пропишем secret/ci/keys.

`vault kv put secret/ci/keys firstKey="test1" secondKey="test2"`

Здесь нашим первым секретом является `firstKey` со значением "test1", вторым - `secondKey` со значением "test2".

При помощи команды `vault kv get secret/ci/keys` можем проверить, что все установилось правильно.

На скрине ниже представлены все перечисленные действия.

![2024-10-11_18-51-10](https://github.com/user-attachments/assets/abf39c48-1af9-4d6d-81e5-e46a8e71cdfa)

Итак, теперь у нас созданы два секрета.

## Разберем пайплайн.

![2024-10-20_23-57-39](https://github.com/user-attachments/assets/23d797b9-e52a-4817-a8ba-f9151b59290c)

Рассмотрим степ:

```
- name: Import Secrets
        id: import-secrets
        uses: hashicorp/vault-action@v2
        with:
        url: http://127.0.0.1:8200
        token: ${{ secrets.VAULT_TOKEN }}
        secrets: |
          secret/data/ci/keys firstKey | FIRST_SECRET_KEY ;
          secret/data/ci/keys secondKey | SECOND_SECRET_KEY ;
```

Здесь мы импортируем секреты из Hashicorp. Указываем url для подключения к Vault, при помощи токена происходит аутентификация. Далее указываем секреты для импорта - `firstKey` и `secondKey`. В пайплайне далее `firstKey` будет доступен как `FIRST_SECRET_KEY`, `secondKey` как `SECOND_SECRET_KEY`. Их можно использовать в других шагах.

В крайнем степе Run tests мы передаем наши секреты в качестве параметров:

```
- name: Run tests
        run: |
          pytest --api ${{ steps.import-secrets.outputs.FIRST_SECRET_KEY }} --pswd ${{ steps.import-secrets.outputs.SECOND_SECRET_KEY }}
```

Итог: мы использовали Vault как секретохранилку, записали туда два секрета. Написанный пайплайн подключается к Vault, происходит аутентификация, далее мы достаем оттуда записанные нами секреты и применяем их там, где нам нужно.
